<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Push Notification Manager</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <!-- OneSignal SDK -->
    <script
      src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"
      defer
    ></script>

    <!-- Firebase SDKs (Compat Version) -->
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- Firebase Messaging SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>

    <!-- Styles -->
    <style>
      /* Global Styles */
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: #101214;
        color: #e0e0e0;
        margin: 0;
        padding: 0;
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Container for Notification Manager */
      .container {
        width: 90%;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        border-radius: 15px;
        background-color: rgba(16, 18, 20, 0.9);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        text-align: center;
      }

      h1,
      h2 {
        text-align: center;
        color: #e0e0e0;
      }

      /* Authentication Modal Styles */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(
          0,
          0,
          0,
          0.5
        ); /* Semi-transparent dark overlay */
        justify-content: center;
        align-items: center;
        display: flex; /* Center the modal */
      }

      .modal-content {
        background-color: #1f2125;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        position: relative;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        color: #e0e0e0;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close-modal:hover {
        color: #00ff88;
      }

      .auth-form {
        width: 100%;
        text-align: center;
      }

      .auth-form h2 {
        margin-bottom: 20px;
      }

      .auth-form input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 8px;
        background-color: #2b2d33;
        color: #fff;
        font-size: 14px;
        border: none;
        outline: none;
      }

      .auth-form button {
        background-color: #00c805;
        color: white;
        cursor: pointer;
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 8px;
        border: none;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }

      .auth-form button:hover {
        background-color: #00b604;
      }

      .error-message {
        color: red;
        font-size: 14px;
        margin-top: 10px;
        display: none;
      }

      /* Toggle Switch Styles */
      .toggle-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 16px;
        margin-top: 30px;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #00c805;
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      input:focus + .slider {
        box-shadow: 0 0 1px #00c805;
      }

      /* Notification History Styles */
      .notification-history {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 40px;
        max-width: 800px;
        width: 90%;
        background-color: rgba(16, 18, 20, 0.9);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        overflow-y: auto;
        max-height: 400px;
      }

      .history-card {
        background: linear-gradient(145deg, #1f2125, #1c1e24);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        color: #e0e0e0;
      }

      .history-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.8);
      }

      .history-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .history-message {
        font-size: 14px;
        margin-bottom: 10px;
      }

      .history-timestamp {
        font-size: 12px;
        color: #8a8d91;
      }

      /* Responsive Design */
      @media (max-width: 480px) {
        .modal-content {
          padding: 20px;
        }

        .auth-form input,
        .auth-form button,
        .toggle-label {
          padding: 10px;
          font-size: 14px;
        }

        .close-modal {
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeAuthModal()">&times;</span>
        <form id="loginForm" class="auth-form">
          <h2>Login</h2>
          <input type="email" id="authEmail" placeholder="Email" required />
          <input
            type="password"
            id="authPassword"
            placeholder="Password"
            required
          />
          <button type="button" id="authButton">Log In</button>
          <p id="errorMessage" class="error-message"></p>
        </form>
      </div>
    </div>

    <!-- Main Container -->
    <div class="container" id="mainContent" style="display: none">
      <h1>Welcome, <span id="userEmail"></span></h1>
      <button id="logoutButton">Log Out</button>

      <!-- Toggle Switch -->
      <div class="toggle-label">
        <label for="notificationToggle">Enable Notifications</label>
        <label class="toggle-switch">
          <input type="checkbox" id="notificationToggle" />
          <span class="slider"></span>
        </label>
      </div>

      <!-- Notification History Section -->
      <h2 style="margin-top: 40px">Notification History</h2>
      <div id="notificationHistory" class="notification-history">
        <!-- Notification history cards will be dynamically inserted here -->
      </div>
    </div>

    <!-- Custom Scripts -->
    <script>
      // Wait for the DOM to load
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded and parsed.");

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyB2o0L88jjjvVpg7y-4jRJ9BiLJsQ1kEPI",
          authDomain: "trade-hero-5b25d.firebaseapp.com",
          databaseURL: "https://trade-hero-5b25d-default-rtdb.firebaseio.com",
          projectId: "trade-hero-5b25d",
          storageBucket: "trade-hero-5b25d.appspot.com",
          messagingSenderId: "478020624328",
          appId: "1:478020624328:web:16c0ab730012f0753b6afd",
          measurementId: "G-5QKMBBGWTK",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase initialized.");
        // Initialize Firebase Messaging
        const messaging = firebase.messaging();
        const { getMessaging } = messaging;
        console.log("messaging>>>", messaging.app.firebase);
        // Request permission to display notifications
        function requestNotificationPermission() {
          return Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              console.log("Notification permission granted.");
              return messaging.getToken();
            } else {
              console.log("Unable to get permission to notify.");
            }
          });
        }

        requestNotificationPermission();
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Get DOM elements
        const authModal = document.getElementById("authModal");
        const authButton = document.getElementById("authButton");
        const authEmail = document.getElementById("authEmail");
        const authPassword = document.getElementById("authPassword");
        const errorMessage = document.getElementById("errorMessage");
        const mainContent = document.getElementById("mainContent");
        const userEmailSpan = document.getElementById("userEmail");
        const logoutButton = document.getElementById("logoutButton");
        const notificationToggle =
          document.getElementById("notificationToggle");
        const notificationHistory = document.getElementById(
          "notificationHistory"
        );

        // Function to subscribe to a topic
        function subscribeToTopic(token, topic) {
          const apiUrl =
            "https://us-central1-trade-hero-5b25d.cloudfunctions.net/subscribeToTopic"; // Replace with your API endpoint

          // Make a POST request to subscribe to the topic
          fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              // "Authorization": `Bearer ${token}`, // Include token in headers if required
            },
            body: JSON.stringify({ data: { token: token, topic: topic } }),
          })
            .then((response) => {
              console.log("response ", response);
              if (response.successCount) {
                alert("Subscribed to Topic");
              }
              return response.json();
            })
            .then((data) => {
              console.log("Successfully subscribed to topic:", data);
            })
            .catch((error) => {
              console.log("Error subscribing to topic:", error);
            });
        }

        // Function to unsubscribe from a topic
        function unsubscribeFromTopic(token, topic) {
          // Use Firebase Admin SDK on your backend to handle topic unsubscriptions

          const apiUrl =
            "https://us-central1-trade-hero-5b25d.cloudfunctions.net/unsubscribeFromTopic"; // Replace with your API endpoint

          // Make a POST request to subscribe to the topic
          fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              // "Authorization": `Bearer ${token}`, // Include token in headers if required
            },
            body: JSON.stringify({ data: { token: token, topic: topic } }),
          })
            .then((response) => {
              console.log("response ", response);
              if (response.successCount) {
                alert("Subscribed to Topic");
              }
              return response.json();
            })
            .then((data) => {
              console.log("Successfully subscribed to topic:", data);
            })
            .catch((error) => {
              console.log("Error subscribing to topic:", error);
            });
        }

        // Toggle event listener to trigger subscription/unsubscription
        notificationToggle.addEventListener("change", async function (event) {
          const user = firebase.auth().currentUser;

          if (!user) {
            console.error("User is not logged in.");
            event.target.checked = false;
            return;
          }

          // Get the device token
          const token = await messaging.getToken();
          console.log("token>>>>", token);
          if (event.target.checked) {
            console.log("Subscribing to topic...", token);
            subscribeToTopic(token, "test");
          } else {
            console.log("Unsubscribing from topic...");
            unsubscribeFromTopic(token, "test");
          }
        });

        // Show authentication modal
        function showAuthModal() {
          console.log("Showing authentication modal.");
          authModal.style.display = "flex";
        }

        // Close authentication modal
        function closeAuthModal() {
          console.log("Closing authentication modal.");
          authModal.style.display = "none";
        }

        // Display error messages
        function showError(message) {
          console.log("Displaying error message:", message);
          errorMessage.style.display = "block";
          errorMessage.textContent = message;
        }

        // Clear error messages
        function clearError() {
          console.log("Clearing error message.");
          errorMessage.style.display = "none";
          errorMessage.textContent = "";
        }

        // Handle user login
        authButton.addEventListener("click", () => {
          const email = authEmail.value.trim();
          const password = authPassword.value.trim();

          console.log("Login button clicked with email:", email);

          if (email === "" || password === "") {
            showError("Please enter both email and password.");
            return;
          }

          firebase
            .auth()
            .signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
              console.log(
                "User signed in successfully:",
                userCredential.user.email
              );
              closeAuthModal();
              clearError();
              mainContent.style.display = "block";
              userEmailSpan.textContent = userCredential.user.email;
              renderNotificationHistory(); // Load notification history on login
            })
            .catch((error) => {
              console.error("Login failed:", error);
              showError("Login failed: " + error.message);
            });
        });

        // Handle user logout
        logoutButton.addEventListener("click", () => {
          firebase
            .auth()
            .signOut()
            .then(() => {
              console.log("User signed out successfully.");
              mainContent.style.display = "none";
              showAuthModal();
            })
            .catch((error) => {
              console.error("Sign out failed:", error);
            });
        });

        // Listen for authentication state changes
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            console.log("User is authenticated:", user.email);
            closeAuthModal();
            mainContent.style.display = "block";
            userEmailSpan.textContent = user.email;
            renderNotificationHistory(); // Load notification history on login
          } else {
            console.log("No user is authenticated.");
            showAuthModal();
            mainContent.style.display = "none";
          }
        });

        // OneSignal Initialization
        window.OneSignal = window.OneSignal || [];
        OneSignal.push(function () {
          console.log("Initializing OneSignal.");
          OneSignal.init({
            appId: "a5ebc02c-1e78-4679-b768-c3255fc4f5f4", // Replace with your actual OneSignal App ID
            autoRegister: false, // Prevent auto-prompt on page load
            notifyButton: {
              enable: false, // Disable the default OneSignal notify button
            },
            promptOptions: {
              slidedown: {
                enabled: true,
                autoPrompt: false, // Control when to prompt manually
              },
            },
          });

          // Function to update Firestore subscription status
          function updateFirestoreSubscriptionStatus(userId, isSubscribed) {
            console.log(
              `Updating Firestore for user ${userId} with isSubscribed: ${isSubscribed}`
            );
            db.collection("users")
              .doc(userId)
              .set(
                {
                  isSubscribed: isSubscribed,
                },
                { merge: true }
              )
              .then(() => {
                console.log(
                  `Subscription status updated in Firestore: ${isSubscribed}`
                );
              })
              .catch((error) => {
                console.error(
                  "Error updating Firestore subscription status:",
                  error
                );
              });
          }

          // Check if the user is subscribed and update the toggle state
          function updateToggleState() {
            // OneSignal.isPushNotificationsEnabled(function (isEnabled) {
            //   console.log("Push Notifications Enabled:", isEnabled);
            //   notificationToggle.checked = isEnabled; // Set toggle based on subscription status
            // });
          }

          // Initialize the page by updating the toggle state
          updateToggleState();

          // Toggle event listener to trigger subscription/unsubscription
          notificationToggle.addEventListener("change", function (event) {
            const user = firebase.auth().currentUser; // Get the current logged-in user

            if (!user) {
              console.error("User is not logged in.");
              event.target.checked = false;
              return;
            }

            if (event.target.checked) {
              console.log("User opted in for notifications.");
              // Trigger OneSignal subscription prompt
              OneSignal.showSlidedownPrompt()
                .then(function () {
                  console.log("User subscribed to push notifications.");
                  updateToggleState(); // Update the toggle after subscription
                  updateFirestoreSubscriptionStatus(user.uid, true); // Update Firestore status to subscribed
                })
                .catch(function (error) {
                  console.log("Error during subscription:", error);
                  event.target.checked = false; // Reset toggle if an error occurred
                });
            } else {
              console.log("User opted out of notifications.");
              // Unsubscribe from OneSignal notifications
              OneSignal.setSubscription(false)
                .then(function () {
                  console.log("User unsubscribed from push notifications.");
                  updateToggleState(); // Update the toggle after unsubscription
                  updateFirestoreSubscriptionStatus(user.uid, false); // Update Firestore status to unsubscribed
                })
                .catch(function (error) {
                  console.log("Error during unsubscription:", error);
                  event.target.checked = true; // Reset toggle if an error occurred
                });
            }
          });

          // Listen for subscription changes to update the toggle
          // OneSignal.on("subscriptionChange", function (isSubscribed) {
          //   console.log(
          //     "Subscription state changed. Is subscribed:",
          //     isSubscribed
          //   );
          //   notificationToggle.checked = isSubscribed; // Keep the toggle synced with the subscription status

          //   const user = firebase.auth().currentUser;
          //   if (user) {
          //     updateFirestoreSubscriptionStatus(user.uid, isSubscribed); // Sync subscription status with Firestore
          //   }
          // });
        });

        // Function to render notification history (fetch from Firestore)
        function renderNotificationHistory() {
          const user = firebase.auth().currentUser;
          if (!user) {
            console.error("User is not logged in.");
            return;
          }

          console.log(`Fetching notification history for user ${user.uid}.`);

          // Fetch notification history from Firestore
          db.collection("users")
            .doc(user.uid)
            .collection("notifications")
            .orderBy("timestamp", "desc")
            .limit(10)
            .get()
            .then((querySnapshot) => {
              notificationHistory.innerHTML = ""; // Clear previous history
              if (querySnapshot.empty) {
                console.log("No notifications found for this user.");
                notificationHistory.innerHTML =
                  "<p>No notifications found.</p>";
                return;
              }
              querySnapshot.forEach((doc) => {
                const data = doc.data();
                console.log("Notification:", data);
                const card = document.createElement("div");
                card.className = "history-card";

                const title = document.createElement("div");
                title.className = "history-title";
                title.textContent = data.title;

                const message = document.createElement("div");
                message.className = "history-message";
                message.textContent = data.message;

                const time = document.createElement("div");
                time.className = "history-timestamp";
                time.textContent = data.timestamp.toDate().toLocaleString();

                card.appendChild(title);
                card.appendChild(message);
                card.appendChild(time);
                notificationHistory.appendChild(card);
              });
            })
            .catch((error) => {
              console.error("Error fetching notification history:", error);
              notificationHistory.innerHTML =
                "<p>Error loading notifications.</p>";
            });
        }

        // Example: Add sample notifications to Firestore (for demonstration purposes only)
        // Remove or comment out this section in production
        /*
            function addSampleNotifications() {
              const user = firebase.auth().currentUser;
              if (user) {
                const notificationsRef = db.collection('users').doc(user.uid).collection('notifications');
                notificationsRef.add({
                  title: "Trade Alert: AAPL",
                  message: "Apple Inc. has reached a new high!",
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                notificationsRef.add({
                  title: "Trade Alert: TSLA",
                  message: "Tesla Motors is experiencing high volatility.",
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                notificationsRef.add({
                  title: "Trade Alert: AMZN",
                  message: "Amazon announces new product launch.",
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
            }

            // Uncomment to add sample notifications
            // firebase.auth().onAuthStateChanged((user) => {
            //   if (user) {
            //     addSampleNotifications();
            //   }
            // });
            */
      });
    </script>

    <!-- custom script for firebase messaging and notification  -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
      import {
        getMessaging,
        getToken,
      } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging.js";
      const firebaseConfig = {
        apiKey: "AIzaSyB2o0L88jjjvVpg7y-4jRJ9BiLJsQ1kEPI",
        authDomain: "trade-hero-5b25d.firebaseapp.com",
        databaseURL: "https://trade-hero-5b25d-default-rtdb.firebaseio.com",
        projectId: "trade-hero-5b25d",
        storageBucket: "trade-hero-5b25d.appspot.com",
        messagingSenderId: "478020624328",
        appId: "1:478020624328:web:16c0ab730012f0753b6afd",
        measurementId: "G-5QKMBBGWTK",
      };

      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);
      const vapidKey =
        "BIbCuXSemIsQGW8qGGNr_3pN0zgZ-LFlc6hQ_3oUTfWEJmaYePhqO5X8sI-489pA_GpInc-F6XhSxnU9MpsopjI";

      // Register the service worker for background notifications
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/firebase-messaging-sw.js")
          .then((registration) => {
            getToken(messaging, {
              ServiceWorkerRegistration: registration,
              vapidKey: vapidKey,
            }).then((currentToken) => {
              if (currentToken) {
                console.log("token retrieved>>", currentToken);

                messaging.onMessage((payload) => {
                  console.log("Foreground message received: ", payload);

                  const notificationTitle = payload.notification.title;
                  const notificationOptions = {
                    body: payload.notification.body,
                    icon: "/your-icon.png", // Optional: replace with your icon path
                  };
                  self.registration.showNotification(
                    notificationTitle,
                    notificationOptions
                  );

                  // Show native notification in the foreground
                  new Notification(notificationTitle, notificationOptions);
                });
              }
            });
          })
          .catch((err) => {
            console.error("Service Worker registration failed:", err);
          });
      }
    </script>
  </body>
</html>
